# String Diagram Engine (Zigzag Structure)

## Frontmatter

```yaml
name: String Diagram Engine (Zigzag Structure)
status: open
created: 2025-08-29T20:11:17Z
updated: 2025-08-30T00:30:00Z
github: https://github.com/AHartNtkn/npr-proof-assistant/issues/14
depends_on: [13]
parallel: false
conflicts_with: []
```

## Description

Implement the core string diagram engine using the zigzag data structure from homotopy.io, adapted for NPR's specific needs. This engine will represent NPR diagrams where "graphs ARE formulas" - not graph traversal structures, but categorical string diagrams with a recursive cospan-based encoding.

The key insight is that NPR diagrams are string diagrams with two colors (white for cartesian/positive, black for cocartesian/negative) but the same underlying zigzag structure. The distinction is merely a color attribute on nodes, not a fundamental structural difference.

## Acceptance Criteria

- [ ] Zigzag data structure implemented following homotopy.io's model
- [ ] Support for 0-dimensional generators (basic NPR elements)
- [ ] Support for n-dimensional diagrams (source + cospans)
- [ ] Color attribute system for white/black distinction
- [ ] NPR-specific generators implemented:
  - [ ] Copier (Δ) and Cocopier (∇)
  - [ ] Discard (!) and Codiscard (?)
  - [ ] Labeled boxes (R) for relations
  - [ ] Identity wires
  - [ ] Symmetry (wire crossing)
- [ ] Sequential composition (vertical stacking)
- [ ] Tensor composition (horizontal placement)
- [ ] Efficient sparse representation using cones
- [ ] Type checking for wire compatibility

## Technical Details

### Zigzag Data Structure
```typescript
type Color = 'white' | 'black';  // Cartesian vs Cocartesian

type Generator = 
  | { kind: 'copier', color: Color }
  | { kind: 'cocopier', color: Color }
  | { kind: 'discard', color: Color }
  | { kind: 'codiscard', color: Color }
  | { kind: 'box', label: string, color: Color }
  | { kind: 'identity', color: Color }
  | { kind: 'symmetry', color: Color };

type Diagram0 = Generator;  // 0-dimensional

type DiagramN = {
  dimension: number;
  source: Diagram;  // (n-1)-dimensional source
  cospans: Cospan[];  // The zigzag
};

type Cospan = {
  left: Cone;
  apex: Diagram;
  right: Cone;
};

type Cone = {
  // Sparse encoding of morphisms between levels
  mapping: Map<number, number>;
};
```

### Key Operations
- **Composition**: Combining diagrams vertically (seq) or horizontally (tensor)
- **Rewriting**: Applying NPR axioms as diagram transformations
- **Rendering**: Converting zigzag to visual representation
- **Hit Detection**: Finding diagram elements at screen coordinates

### NPR-Specific Features
- Color tracking throughout the structure
- Validation that compositions respect color constraints
- Support for boxes with arbitrary relation labels
- Wire type system (though all wires are fundamentally the same type in NPR)

## Dependencies

- Task #13: Core Architecture Setup (provides React/TypeScript foundation)
- No external graph libraries needed - this is a custom data structure
- Will use the rendering canvas from #13 for visualization

## Effort Estimate

**Large (L)** - 24 hours

This is complex work requiring:
- Understanding and implementing the zigzag construction
- Adapting it for NPR's two-color system
- Building all NPR-specific generators
- Creating composition operations
- Ensuring type safety throughout

## Definition of Done

- Zigzag data structure fully implemented
- All NPR generators supported
- Composition operations working correctly
- Color system properly tracked
- Type checking validates diagram construction
- Unit tests cover all diagram operations
- Can construct and compose basic NPR diagrams
- Data structure ready for Formula Mode (#16) and Proof Mode (#18)