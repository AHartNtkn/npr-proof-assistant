# Formula Mode Development

## Frontmatter

```yaml
name: Formula Mode Development
status: open
created: 2025-08-29T20:11:17Z
updated: 2025-08-30T00:35:00Z
github: https://github.com/AHartNtkn/npr-proof-assistant/issues/16
depends_on: [14]
parallel: false
conflicts_with: []
```

## Description

Develop the Formula Mode interface that allows users to construct NPR string diagrams through intuitive visual interactions. This mode should feel like "drawing with Lego bricks" - creative and unrestricted, where users build categorical diagrams by placing generators and composing them.

Formula Mode is about constructing well-typed string diagrams freely, without the constraint of following axiom applications. Users should be able to place copiers, discards, boxes, and other NPR generators, then compose them using sequential (;) and tensor (⊗) operations.

## Acceptance Criteria

- [ ] Generator palette with all NPR elements:
  - [ ] White (cartesian) generators: copier, discard, cocopier, codiscard
  - [ ] Black (cocartesian) generators: copier, discard, cocopier, codiscard
  - [ ] Labeled boxes (relations) in both colors
  - [ ] Identity wires and symmetry (crossing)
- [ ] Drag-and-drop placement of generators onto canvas
- [ ] Composition tools:
  - [ ] Sequential composition (vertical stacking)
  - [ ] Tensor composition (horizontal placement)
  - [ ] Automatic wire management between composed elements
- [ ] Type checking ensures valid compositions
- [ ] Visual distinction between white and black elements
- [ ] Undo/redo for all construction operations
- [ ] Copy/paste for diagram fragments
- [ ] Clear visual feedback for valid/invalid compositions

## Technical Details

### Generator Palette
```typescript
interface GeneratorPalette {
  cartesian: {
    copier: Generator;      // Δ - duplicates wire
    discard: Generator;     // ! - terminates wire
    cocopier: Generator;    // ∇ - merges wires
    codiscard: Generator;   // ? - creates wire
  };
  cocartesian: {
    // Same generators but in black color
  };
  relations: Map<string, Generator>;  // User-defined boxes
  structural: {
    identity: Generator;    // Id wire
    symmetry: Generator;    // Wire crossing
  };
}
```

### Composition Interface
- **Sequential**: Click two diagrams to stack them vertically
- **Tensor**: Click two diagrams to place them side-by-side
- **Wire Matching**: Automatic validation that output wires match input wires
- **Visual Preview**: Ghost preview before confirming composition

### Interaction Model
- **Direct Manipulation**: Following homotopy.io's approach
- **Mouse-based**: Click to select, drag to move, click endpoints to compose
- **No Text Input**: Everything is visual manipulation
- **Smooth Animations**: Spring physics for satisfying interactions

### Type System
- All wires have the same type (the universal domain in NPR)
- Type checking ensures:
  - Wire counts match between compositions
  - Color consistency (no mixing white/black in invalid ways)
  - Well-formed diagram structure

## Dependencies

- Task #14: String Diagram Engine (provides zigzag data structure)
- Uses the canvas from #13 for rendering
- No dependencies on proof mode - this is free construction

## Effort Estimate

**Medium (M)** - 20 hours

Building the interface for free diagram construction with:
- Generator palette implementation
- Composition tools
- Type checking integration
- Visual feedback systems

## Definition of Done

- All NPR generators available in palette
- Can construct arbitrary well-typed string diagrams
- Sequential and tensor composition working smoothly
- Type checking prevents invalid constructions
- Visual distinction between cartesian (white) and cocartesian (black)
- Undo/redo functionality complete
- Satisfying animations and interactions
- Ready for proof mode to manipulate constructed formulas