# Formula Mode Development

## Frontmatter

```yaml
name: Formula Mode Development
status: pending
created: 2025-08-29T20:11:17Z
updated: 2025-08-29T20:22:17Z
github: https://github.com/AHartNtkn/npr-proof-assistant/issues/16
depends_on: ["002"]
parallel: false
conflicts_with: []
```

## Description

Develop the Formula Mode interface that allows users to build NPR diagrams through intuitive visual interactions. This mode should feel like "drawing with Lego bricks" - creative and unrestricted, where users can construct formulas by placing nodes, connecting edges, and organizing elements spatially.

The interface must provide immediate visual feedback for type compatibility, well-formedness validation, and maintain the playful, fidget-toy-like interaction quality that makes formula building engaging and satisfying.

## Acceptance Criteria

- [ ] Node palette with all NPR element types (boxes, junctions, terminals)
- [ ] Drag-and-drop functionality for placing nodes from palette to canvas
- [ ] Edge creation through click-and-drag between compatible connection points
- [ ] Real-time type checking with visual feedback (colors, highlights, warnings)
- [ ] Well-formedness validation with clear error indicators
- [ ] Undo/redo functionality for all formula building operations
- [ ] Selection system supporting single and multi-element selection
- [ ] Copy/paste functionality for diagram fragments
- [ ] Smooth animations for all interactions

## Technical Details

### Node Palette System
- **Organization**: Categorized by NPR element types and functions
- **Search/Filter**: Quick access to specific elements
- **Drag Initialization**: Smooth drag start with visual feedback
- **Preview**: Hover effects showing element descriptions

### Interaction System
- **Mouse Handling**: Precise click detection using spatial indexing from engine
- **Touch Support**: Multi-touch gestures for mobile/tablet compatibility
- **Keyboard Shortcuts**: Power-user shortcuts for common operations
- **Gesture Recognition**: Intuitive gestures for element manipulation

### Visual Feedback System
- **Type Compatibility**: Color-coded connection points and edges
- **Validation States**: Real-time indicators for diagram well-formedness
- **Hover Effects**: Preview connections and highlight compatible elements
- **Animation System**: Smooth, satisfying transitions with easing

### Edit Operations
- **Node Placement**: Snap-to-grid option with visual guides
- **Edge Routing**: Automatic routing with manual override capability
- **Element Properties**: In-place editing of labels and parameters
- **Bulk Operations**: Multi-select operations for efficiency

### Formula Validation
- **Type System Integration**: Real-time checking using graph engine
- **Error Reporting**: Non-intrusive feedback for invalid configurations
- **Suggestion System**: Helpful hints for completing partial formulas
- **Export Validation**: Ensure formulas are complete before mode switching

## Dependencies

- **Depends on**: [14] Graph Engine Implementation
- **Requires**: Type system and spatial indexing from graph engine
- **Integrates**: Rendering system from [13] Core Architecture Setup

## Effort Estimate

**Medium (M)** - 20 hours

## Definition of Done

- All NPR element types can be placed and configured
- Drag-and-drop interactions feel smooth and responsive
- Type checking provides immediate, clear feedback
- Complex formulas can be built without performance issues
- Undo/redo system works correctly for all operations
- Formula validation catches all known error cases
- Interface feels playful and engaging to use
- User testing confirms intuitive operation
- All acceptance criteria are met and verified
