# Proof Mode Engine

## Frontmatter

```yaml
name: Proof Mode Engine
status: open
created: 2025-08-29T20:11:17Z
updated: 2025-08-30T00:40:00Z
github: https://github.com/AHartNtkn/npr-proof-assistant/issues/18
depends_on: [14]
parallel: true
conflicts_with: []
```

## Description

Implement the Proof Mode engine that allows users to transform NPR string diagrams through valid axiom applications. Unlike Formula Mode's free construction, Proof Mode constrains interactions to valid rewrite rules based on NPR's cartesian and cocartesian bicategory axioms.

This mode should feel like "manipulating a physical puzzle" where users can only make moves that follow the rules. The engine must support hover-to-preview and click-to-apply interactions, showing users exactly what transformations are available at each point in the diagram.

## Acceptance Criteria

- [ ] Axiom detection system that identifies applicable rewrites in a diagram
- [ ] Hover-to-preview showing the result of applying an axiom
- [ ] Click-to-apply executing the diagram transformation
- [ ] Support for all NPR axioms:
  - [ ] Cartesian bicategory axioms (white)
  - [ ] Cocartesian bicategory axioms (black)
  - [ ] Linear distribution axioms
  - [ ] Linear adjunction axioms
- [ ] Proof history tracking with undo/redo
- [ ] Axiom palette showing available rules
- [ ] Visual highlighting of applicable axiom locations
- [ ] Smooth animations for diagram transformations
- [ ] Proof verification ensuring each step is valid

## Technical Details

### Rewrite System
```typescript
interface Rewrite {
  name: string;           // Axiom name
  pattern: Diagram;       // LHS pattern to match
  replacement: Diagram;   // RHS replacement
  bidirectional: boolean; // Can apply in both directions
  color: Color | 'both';  // Applicable to white, black, or both
}

interface RewriteEngine {
  findMatches(diagram: Diagram, axiom: Rewrite): Match[];
  preview(diagram: Diagram, match: Match): Diagram;
  apply(diagram: Diagram, match: Match): Diagram;
  validate(oldDiagram: Diagram, newDiagram: Diagram): boolean;
}
```

### Axiom Categories
- **Comonoid Laws**: Associativity, commutativity, unit for copier/discard
- **Monoid Laws**: Dual laws for cocopier/codiscard
- **Frobenius Laws**: Interaction between monoid and comonoid
- **Special Frobenius**: Additional constraint for cartesian structure
- **Linear Distribution**: How white composition distributes over black
- **Linear Adjunction**: Adjoint relationships between structures

### Interaction Model
- **Hover Detection**: Find axioms applicable at mouse position
- **Preview Generation**: Show ghost overlay of transformation result
- **Click Application**: Execute the rewrite with animation
- **Multi-step Preview**: Chain multiple axioms to preview complex proofs

### Proof History
```typescript
interface ProofStep {
  diagram: Diagram;
  axiomApplied: string;
  location: Match;
  timestamp: number;
}

interface ProofHistory {
  steps: ProofStep[];
  currentIndex: number;
  undo(): void;
  redo(): void;
  branch(): ProofHistory;  // For exploring alternatives
}
```

## Dependencies

- Task #14: String Diagram Engine (provides zigzag structure and rewriting)
- Uses canvas from #13 for rendering
- Independent of Formula Mode - operates on any valid diagram

## Effort Estimate

**Large (L)** - 24 hours

Complex implementation including:
- Pattern matching for axiom detection
- Rewrite engine implementation
- Preview system
- History management
- Animation system for transformations

## Definition of Done

- All NPR axioms implemented as rewrite rules
- Pattern matching correctly identifies applicable axioms
- Hover preview shows transformation results
- Click application executes rewrites smoothly
- Proof history with full undo/redo support
- Visual feedback for available moves
- Animations make transformations clear
- Cannot make invalid proof steps
- Ready to prove theorems using NPR axioms