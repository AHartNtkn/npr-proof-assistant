# Task 007: Persistence Layer

**Epic:** proof-assistant  
**Status:** not-started  
**Created:** 2025-08-29T20:11:17Z  
**Updated:** 2025-08-29T20:11:17Z  
**GitHub:** https://github.com/ahart/NPRAssistant/issues/7  
**Depends on:** [16, 18]  
**Can run in parallel with:** visual polish tasks  
**Conflicts with:** none  

## Description

Build a comprehensive persistence layer for the NPR Proof Assistant that handles local storage, save/load functionality, and undo/redo operations. This system must support the dual-mode nature of the application (formula building vs proof construction) with separate undo stacks and appropriate state management for each mode.

The persistence layer should be robust, performant, and designed for offline-first operation while supporting easy sharing and collaboration through export/import mechanisms.

## Acceptance Criteria

### Core Storage
- [ ] IndexedDB wrapper implemented with proper error handling
- [ ] Graph serialization/deserialization with full fidelity
- [ ] Automatic save functionality with configurable intervals
- [ ] Manual save with user feedback and conflict resolution
- [ ] Robust error handling for storage quota and corruption issues

### Undo/Redo System
- [ ] Separate undo stacks for formula building and proof modes
- [ ] Configurable stack depth with memory management
- [ ] Efficient state diffing to minimize storage overhead
- [ ] Keyboard shortcuts (Ctrl+Z, Ctrl+Y) with proper event handling
- [ ] Visual indicators for undo/redo availability

### Save/Load Interface
- [ ] Project browser with thumbnails and metadata
- [ ] Quick save/load with hotkeys
- [ ] Auto-recovery from crashes or unexpected closure
- [ ] Version history with branching support for experiments
- [ ] Search and filtering capabilities for large project collections

### Export/Import
- [ ] Multiple export formats (native, PNG, SVG, PDF)
- [ ] Shareable links with embedded graph data
- [ ] Import validation with error reporting
- [ ] Batch operations for multiple files
- [ ] Integration with browser's file system APIs where available

## Technical Details

### Storage Architecture
```typescript
interface GraphState {
  id: string;
  name: string;
  mode: 'formula' | 'proof';
  graph: SerializedGraph;
  metadata: ProjectMetadata;
  created: Date;
  modified: Date;
  version: number;
}

interface UndoStack {
  states: GraphState[];
  currentIndex: number;
  maxSize: number;
}
```

### IndexedDB Schema
- **projects**: Main storage for graph states
- **metadata**: Project information and search indices
- **snapshots**: Undo/redo state storage
- **preferences**: User settings and configurations
- **cache**: Temporary storage for performance optimization

### Performance Considerations
- Lazy loading of large graphs with viewport-based rendering
- Incremental serialization for frequent saves
- Background compression for long-term storage
- Memory-mapped undo stacks to prevent memory leaks
- Debounced auto-save to prevent performance degradation

### File Format Specification
```json
{
  "version": "1.0",
  "type": "npr-graph",
  "metadata": {
    "name": "Project Name",
    "created": "2025-08-29T20:11:17Z",
    "author": "user@example.com",
    "description": "Optional description"
  },
  "graph": {
    "nodes": [...],
    "edges": [...],
    "layout": {...}
  },
  "history": [...]
}
```

## Dependencies

### Technical Dependencies
- **Task 003**: Core graph operations must be stable
- **Task 004**: Mode system architecture required for dual undo stacks
- IndexedDB API and modern browser storage capabilities
- File System Access API for advanced file operations
- Web Workers for background serialization tasks

### Integration Points
- Graph renderer for generating thumbnails
- UI components for save/load dialogs
- Keyboard shortcut system for undo/redo
- Error handling and user notification systems

## Effort Estimate
**Medium (M)** - 16 hours

### Breakdown
- IndexedDB wrapper and schema design: 4 hours
- Serialization system: 3 hours
- Undo/redo implementation: 4 hours
- Save/load UI and logic: 3 hours
- Export/import functionality: 2 hours

## Definition of Done

### Functionality
- Users can save and load projects reliably
- Undo/redo works correctly in both formula and proof modes
- Auto-save prevents data loss without impacting performance
- Export/import allows easy sharing of graphs
- System handles storage errors gracefully

### Quality
- All persistence operations have comprehensive error handling
- Performance remains smooth with large graphs (>1000 nodes)
- Memory usage stays bounded with proper cleanup
- Data integrity maintained across browser sessions
- Full test coverage for all storage operations

### User Experience
- Save/load operations feel instant (<100ms perceived)
- Clear visual feedback for all persistence actions
- Intuitive project organization and discovery
- Seamless recovery from unexpected application closure
- Export formats work correctly with external tools

## Notes

This task focuses on the infrastructure that makes the proof assistant practical for real use. The persistence layer must be rock-solid since users will be investing significant time in creating proofs and formulas.

Consider implementing a plugin architecture for export formats to allow future extensions for specialized mathematical software integration.
